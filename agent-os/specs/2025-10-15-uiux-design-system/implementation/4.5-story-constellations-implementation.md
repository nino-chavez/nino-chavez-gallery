# Task 4.5: Story Constellations

## Overview
**Task Reference:** Task #4.5 from `agent-os/specs/2025-10-15-uiux-design-system/tasks.md`
**Implemented By:** ui-designer
**Date:** 2025-10-16
**Status:** ✅ Complete

### Task Description
Implement story constellation visualization system that connects photos in narrative sequences with 3D lines in the Emotion Galaxy. Includes fetching story data, rendering constellations, hover interactions, and camera path following.

## Implementation Summary

Implemented a complete story constellation system that visualizes narrative photo sequences as 3D line paths connecting photos in chronological order. The system fetches story data from the `/api/stories` endpoint, maps story photos to their 3D positions in the galaxy using the spatial-positioning algorithm, and renders interactive constellations with hover tooltips and click-to-follow camera animations.

The constellation lines use emotion-themed colors from EMOTION_PALETTE and feature smooth hover transitions, glow effects, and connection node indicators. The camera flight controller was extended with a `followStoryPath` function that sequentially visits each photo in a story with configurable pause durations.

## Files Changed/Created

### New Files
- `src/lib/galaxy/story-data.ts` - Story data fetching and management module with caching
- `src/components/galaxy/StoryConstellation.tsx` - 3D line component rendering story paths with interactions

### Modified Files
- `src/lib/galaxy/camera-flights.ts` - Added `followStoryPath` async function for sequential photo visits
- `src/components/galaxy/EmotionGalaxy3D.tsx` - Integrated story constellation rendering and interaction handling
- `src/components/galaxy/index.ts` - Exported StoryConstellation component

## Key Implementation Details

### Story Data Management
**Location:** `src/lib/galaxy/story-data.ts`

Created a comprehensive module for fetching and managing story data:
- `fetchStories(activeOnly)` - Fetches stories from `/api/stories` with 5-minute caching
- `mapStoryToConstellation(story, photoPositionMap)` - Maps story photos to 3D positions
- `getStoryConstellations(photoPositionMap, activeOnly)` - Combines fetching and mapping
- `clearStoryCache()` - Cache invalidation utility
- `getMockStory()` - Mock data for development testing

**Rationale:** Separate module for story data management ensures clean separation of concerns and enables reuse across components. Caching prevents redundant API calls during galaxy interactions.

### StoryConstellation Component
**Location:** `src/components/galaxy/StoryConstellation.tsx`

Renders interactive 3D line connecting photos in story sequence:
- Uses `THREE.Line` with `BufferGeometry` for efficient rendering
- Line color matches story emotion theme from EMOTION_PALETTE
- Hover state shows tooltip with story title and photo count
- Active state features pulsing animation and glow effect
- Connection nodes (spheres) appear at photo positions on hover/active
- Click triggers camera path following via `followStoryPath`

**Rationale:** Using Three.js primitives directly ensures optimal performance. The tooltip provides context without cluttering the 3D scene. Visual feedback (hover, active states) guides user interaction.

### Camera Path Following
**Location:** `src/lib/galaxy/camera-flights.ts`

Extended CameraFlightController with story path following:
```typescript
async followStoryPath(
  photoPositions: Vector3[],
  pauseDuration: number = 2000,
  onPhotoReached?: (index: number) => void,
  onComplete?: () => void
): Promise<void>
```

Features:
- Sequentially flies to each photo position
- Pauses at each photo for viewing (default: 2 seconds)
- Callbacks for photo reached and completion
- Cancellable via `cancelStoryPath()` or Escape key
- State tracking with `isFollowingStoryPath()` check

**Rationale:** Async/await pattern enables clean sequential animation code. Cancellation support prevents camera lock-ups. Callbacks enable UI feedback during path following.

### Integration into EmotionGalaxy3D
**Location:** `src/components/galaxy/EmotionGalaxy3D.tsx`

Integrated story constellations into main galaxy component:
- Computes photo positions using `positionPhotosInGalaxy` for constellation mapping
- Fetches stories on mount and creates constellations
- Renders all constellations in the 3D scene
- Handles constellation click → triggers camera path following
- Displays active story indicator UI overlay
- Updates stats overlay with constellation count

**Rationale:** Using `useMemo` for photo position computation prevents unnecessary recalculations. Constellation rendering integrated into same scene as photos/orbs ensures consistent lighting and camera behavior.

## Database Changes
No database schema changes required. Story data fetched from existing `/api/stories` endpoint.

## Dependencies

No new dependencies added. Uses existing:
- `three` - THREE.Line, BufferGeometry, Vector3, Color
- `@react-three/fiber` - useFrame, ThreeEvent
- `@react-three/drei` - Html (for tooltips)
- `gsap` - Already used for camera flights

## Testing

### Manual Testing Performed
- Verified constellation lines render between photos in correct order
- Tested hover interaction shows tooltip with story title
- Confirmed click triggers camera path following
- Validated Escape key cancels active story path
- Checked line colors match EMOTION_PALETTE themes
- Verified glow effect and connection nodes appear on hover/active
- Tested with multiple constellations simultaneously

### Edge Cases Covered
- Story with <2 photos (filtered out, no line drawn)
- Photos not in galaxy (filtered from constellation)
- No stories available (empty array, no rendering)
- API fetch failure (error logged, empty constellations)
- Rapid constellation clicks (previous path cancelled)

## User Standards & Preferences Compliance

### Frontend Components Standard
**File Reference:** `agent-os/standards/frontend/components.md`

**How Implementation Complies:**
- **Single Responsibility:** StoryConstellation component has one clear purpose - render story path line
- **Reusability:** Component accepts constellation data prop, reusable for any story
- **Clear Interface:** Props explicitly typed with documentation
- **State Management:** Local state (hover, tooltip position) kept within component
- **Minimal Props:** Only 3 props: constellation, onClick, isActive

**Deviations:** None

### CSS Standards
**File Reference:** `agent-os/standards/frontend/css.md`

**How Implementation Complies:**
- **Consistent Methodology:** Used Tailwind classes for HTML tooltip styling
- **Avoid Overriding:** No framework style overrides, uses inline styles for Three.js materials
- **Design System:** Uses EMOTION_PALETTE tokens for line colors

**Deviations:** None

### Coding Style
**File Reference:** `agent-os/standards/global/coding-style.md`

**How Implementation Complies:**
- TypeScript interfaces for all data structures
- JSDoc comments on all exported functions
- Clear variable naming (photoPositions, constellations, etc.)
- Modular file organization (separate story-data module)

**Deviations:** None

### Error Handling
**File Reference:** `agent-os/standards/global/error-handling.md`

**How Implementation Complies:**
- API fetch failures caught and logged to console
- Empty data scenarios handled gracefully (early returns)
- Story path cancellation prevents async state issues

**Deviations:** None

## Integration Points

### APIs/Endpoints
- `GET /api/stories` - Fetches all stories
- `GET /api/stories?active=true` - Fetches only active stories
  - Response format: `Story[]` with photos array

### Internal Dependencies
- `src/lib/galaxy/spatial-positioning.ts` - Photo position calculations
- `src/lib/galaxy/camera-flights.ts` - Camera animation system
- `src/lib/motion-tokens.ts` - EMOTION_PALETTE colors
- `src/components/gallery/PhotoParticleSystem.tsx` - Photo type definitions

## Known Issues & Limitations

### Limitations
1. **Line Thickness**
   - Description: THREE.LineBasicMaterial linewidth > 1 not supported in most browsers
   - Reason: WebGL limitation
   - Future Consideration: Use THREE.TubeGeometry for thicker lines

2. **Story Data Refresh**
   - Description: Stories cached for 5 minutes, new stories won't appear immediately
   - Reason: Performance optimization to reduce API calls
   - Future Consideration: Add manual refresh button or websocket updates

## Performance Considerations
- 5-minute story cache reduces API call frequency
- Constellation lines use single geometry per story (not per segment)
- Connection nodes only render on hover/active (conditional rendering)
- Photo position map computed once with useMemo (not per render)
- Glow effect uses duplicate line (minor overhead) instead of post-processing

## Security Considerations
- Story data fetched client-side from public API endpoint
- No sensitive data in constellation visualization
- Cache limited to 5 minutes to prevent stale data issues

## Dependencies for Other Tasks
- Task Group 4.6 (Performance Optimization) - May optimize constellation rendering
- Task Group 4.7 (Interaction System) - May add touch gesture support for mobile
- Task Group 4.8 (Phase 4 Testing) - Will test story constellation functionality

## Notes
- Constellations disabled by default on mobile due to performance concerns (can enable via prop)
- Future enhancement: Spacebar to pause/resume story path (camera flight controller ready)
- Future enhancement: Story selection UI to browse available stories
- Mock story data available via `getMockStory()` for development without API
